# .claudecode.md

Notas e descobertas de desenvolvimento com Claude Code para o projeto Paper Agent.

---

## üîß Setup e Ambiente

### Ambiente Virtual (venv)

**Problema:** O ambiente CI/CD do Claude Code pode n√£o ter venv configurado automaticamente.

**Solu√ß√£o:**
```bash
# Sempre verificar se venv existe antes de rodar comandos
ls -la venv/bin/activate 2>/dev/null || python -m venv venv

# Ativar venv antes de qualquer comando Python
source venv/bin/activate  # Linux/Mac
.\venv\Scripts\Activate.ps1  # Windows
```

**Nota:** README j√° documenta isso, mas em ambientes CI √© f√°cil esquecer.

---

## üß™ Testes

### Testes de Integra√ß√£o e Vari√°veis de Ambiente

**Problema:** Testes de integra√ß√£o falham com "ANTHROPIC_API_KEY n√£o encontrada" mesmo quando .env existe.

**Causa:** Pytest n√£o carrega `.env` automaticamente. √â preciso chamar `load_dotenv()` explicitamente no arquivo de teste.

**Solu√ß√£o:**
```python
import os
from pathlib import Path
from dotenv import load_dotenv

# Carregar .env na raiz do projeto
project_root = Path(__file__).parent.parent.parent  # Ajustar conforme localiza√ß√£o
env_path = project_root / ".env"
load_dotenv(dotenv_path=env_path)

# Agora os.getenv("ANTHROPIC_API_KEY") funciona
assert os.getenv("ANTHROPIC_API_KEY"), "API key n√£o encontrada"
```

**Refer√™ncia:** `tests/integration/test_methodologist_smoke.py` (corrigido em 10/11/2025)

---

### Pytest Markers

**Problema:** Warnings sobre marcadores desconhecidos (`@pytest.mark.integration`).

**Solu√ß√£o:** Registrar marcadores customizados em `pytest.ini`:
```ini
[pytest]
markers =
    integration: Integration tests that require API access
    unit: Unit tests that use mocks
```

**Arquivo:** `pytest.ini` (criado em 10/11/2025)

---

## üìÅ Estrutura de Arquivos

### Testes de Integra√ß√£o

**Localiza√ß√£o:** `tests/integration/`
**Conven√ß√£o:** `test_*.py`
**Marcador:** `@pytest.mark.integration`

**Exemplo:**
```python
@pytest.mark.integration
def test_methodologist_complete_flow():
    """Teste que usa API real."""
    assert os.getenv("ANTHROPIC_API_KEY"), "Configure API key"
    # ... resto do teste
```

**Rodar apenas testes de integra√ß√£o:**
```bash
pytest tests/integration/ -v
# ou
pytest -m integration -v
```

---

## ü§ñ LangGraph e Interrupts

### Handling de Interrupts (ask_user)

**Padr√£o:** Usar `Command(resume=...)` para retomar ap√≥s interrupt.

**Exemplo:**
```python
from langgraph.types import Command

# Primeira invoca√ß√£o
graph.invoke(state, config=config)

# Loop para processar interrupts
while True:
    snapshot = graph.get_state(config)

    if not snapshot.next:
        break  # Grafo finalizou

    # Processar interrupts
    for task in snapshot.tasks:
        if task.interrupts:
            for interrupt in task.interrupts:
                question = interrupt.value
                answer = input(f"Responda: {question}")

                # Retomar execu√ß√£o com resposta
                graph.invoke(Command(resume=answer), config=config)
```

**Refer√™ncia:**
- `cli/chat.py:157-159` - CLI interativo
- `tests/integration/test_methodologist_smoke.py:157-160` - Teste automatizado

---

## üìù Documenta√ß√£o

### Princ√≠pio de Responsabilidade √önica

**Regra:** Cada documento tem UMA responsabilidade. N√£o duplicar informa√ß√µes.

| Documento | Responsabilidade |
|-----------|------------------|
| **README.md** | Getting Started: setup, comandos gerais |
| **ROADMAP.md** | Status de √©picos/tasks, crit√©rios de aceite |
| **ARCHITECTURE.md** | Estrutura t√©cnica, decis√µes arquiteturais |
| **development_guidelines.md** | Processo de trabalho com agentes |
| **.claudecode.md** | Descobertas de desenvolvimento, armadilhas |

**Evitar:**
- ‚ùå Duplicar comandos de valida√ß√£o entre README e ROADMAP
- ‚ùå Incluir status de tasks no README
- ‚ùå Incluir setup no ROADMAP

**Refer√™ncia:** `development_guidelines.md` - Se√ß√£o "Regras Anti-Redund√¢ncia"

---

## üêõ Debugging

### Logs do LangGraph

**Ativar logging detalhado:**
```python
import logging

logging.basicConfig(
    level=logging.DEBUG,  # ou INFO
    format='%(levelname)s: %(message)s'
)
```

**Logs √∫teis:**
- `analyze` node: An√°lise da hip√≥tese
- `ask_clarification` node: Perguntas formuladas
- `decide` node: Decis√£o final
- `router`: Decis√£o de qual n√≥ executar

---

## üí° Boas Pr√°ticas Descobertas

### 1. Scripts de Valida√ß√£o Manual

**Por qu√™:** Facilita entender e testar m√≥dulos sem executar toda a aplica√ß√£o.

**Padr√£o:**
```python
"""
Script de valida√ß√£o manual para [m√≥dulo].

Valida que [m√≥dulo] foi implementado com:
- Feature 1
- Feature 2
"""

if __name__ == "__main__":
    try:
        validate_module()
        print("‚úÖ TODOS OS TESTES PASSARAM!")
    except AssertionError as e:
        print(f"‚ùå ERRO: {e}")
        sys.exit(1)
```

**Localiza√ß√£o:** `scripts/validate_*.py`

### 2. Testes de Integra√ß√£o como Smoke Tests

**Smoke test:** Teste m√≠nimo que valida fluxo completo end-to-end.

**Benef√≠cios:**
- Detecta quebras de integra√ß√£o cedo
- Valida que API/depend√™ncias externas funcionam
- Serve como documenta√ß√£o viva do comportamento esperado

**Exemplo:** `tests/integration/test_methodologist_smoke.py`

### 3. Pytest Fixtures para Setup Comum

**TODO:** Implementar fixtures em `tests/conftest.py` para:
- Criar estados iniciais padr√£o
- Mockar configura√ß√µes de API
- Compartilhar setup entre testes

---

## üö® Armadilhas Comuns

### 1. Esquecer de carregar .env em testes

**Sintoma:** `os.getenv("ANTHROPIC_API_KEY")` retorna `None` mesmo com .env configurado.

**Solu√ß√£o:** Sempre adicionar no in√≠cio do arquivo de teste:
```python
from dotenv import load_dotenv
load_dotenv()
```

### 2. Windows vs Linux: Comandos de Shell

**Problema:** Comandos em development_guidelines podem usar sintaxe Linux.

**Solu√ß√£o:**
- Documentar vers√µes PowerShell E Bash
- Preferir comandos Python multiplataforma quando poss√≠vel

**Exemplo:**
```bash
# ‚ùå Linux-only
export PYTHONPATH=.

# ‚úÖ Python (funciona em todos OS)
import sys
sys.path.insert(0, str(project_root))
```

### 3. pytest.ini vs pyproject.toml

**Escolha:** `pytest.ini` foi escolhido por ser mais simples e focado.

**Alternativa:** `pyproject.toml` seria melhor para projetos com mais ferramentas (black, mypy, etc).

---

## üìä M√©tricas e Custos

### Custos de Testes de Integra√ß√£o

**Modelo:** Claude 3.5 Haiku

**Custo estimado por teste:**
- Smoke test completo: ~$0.01 USD
- Teste com 2 itera√ß√µes: ~$0.005 USD

**Recomenda√ß√£o:** Rodar testes de integra√ß√£o localmente antes de push para economizar.

---

## üîÑ Fluxo de Trabalho T√≠pico

### Implementar Nova Funcionalidade

1. **Ler contexto obrigat√≥rio:**
   - ROADMAP.md (crit√©rios de aceite)
   - ARCHITECTURE.md (estrutura t√©cnica)
   - development_guidelines.md (processo)

2. **Criar todo list:**
   ```python
   TodoWrite([
       {"content": "Tarefa 1", "status": "pending"},
       {"content": "Tarefa 2", "status": "pending"}
   ])
   ```

3. **Implementar com TDD onde aplic√°vel:**
   - L√≥gica de neg√≥cio: TDD obrigat√≥rio
   - UI/CLI: Manual OK

4. **Validar antes de commit:**
   - Rodar testes unit√°rios
   - Criar script de valida√ß√£o manual
   - Rodar script de valida√ß√£o

5. **Commit + Push:**
   - Mensagem descritiva
   - Incluir "Task X.Y" no final

6. **Atualizar documenta√ß√£o:**
   - ROADMAP.md: Marcar task como conclu√≠da
   - ARCHITECTURE.md: Se mudou estrutura
   - README.md: Se mudou setup/comandos

---

## üåê Conven√ß√µes do Projeto

### Estrat√©gia de Idioma (PT-BR + EN)

**Regra geral:** Bilinguismo estrat√©gico para otimizar usabilidade e manutenibilidade.

#### üáßüá∑ Usar Portugu√™s Brasileiro em:
- ‚úÖ Mensagens ao usu√°rio final (CLI, logs, erros)
- ‚úÖ Docstrings e coment√°rios internos
- ‚úÖ Documenta√ß√£o t√©cnica (`docs/`)
- ‚úÖ Commits e PRs

#### üá¨üáß Usar English em:
- ‚úÖ C√≥digo (vari√°veis, fun√ß√µes, classes)
- ‚úÖ Nomes de arquivos/pastas
- ‚úÖ Configura√ß√µes t√©cnicas (pytest.ini, requirements.txt)

**Justificativa:**
- Audi√™ncia principal √© brasileira/acad√™mica ‚Üí PT-BR para comunica√ß√£o
- Conven√ß√£o universal de programa√ß√£o ‚Üí EN para c√≥digo
- Compatibilidade com ferramentas ‚Üí EN para nomes t√©cnicos

**Exemplo correto:**
```python
def create_methodologist_graph():
    """
    Cria o grafo do agente Metodologista.

    Este grafo implementa o fluxo de an√°lise de hip√≥teses cient√≠ficas.
    """
    initial_state = create_initial_state(hypothesis)
    print("üî¨ Analisando hip√≥tese...")  # Mensagem em PT-BR
    return graph
```

**Documenta√ß√£o completa:** `docs/process/development/language_guidelines.md`

---

## üîÆ Melhorias Futuras (Backlog)

### Melhorias de Qualidade e Infraestrutura

**Contexto:** Estas melhorias est√£o documentadas no `ROADMAP.md` se√ß√£o "PR√ìXIMOS PASSOS", mas **n√£o s√£o priorit√°rias** para uso pessoal atual. S√≥ implementar quando necess√°rio (primeiro contribuidor externo, escala, etc).

#### 1. Estrutura de Projeto (src layout)
- Migrar para `src/paper_agent/` com `pyproject.toml`
- Remover hacks de `sys.path` via `pip install -e .`
- **Esfor√ßo:** ~4-6 horas
- **Quando:** Primeiro contribuidor externo ou >10k linhas

#### 2. Consolida√ß√£o de Configura√ß√£o
- Migrar `pytest.ini` para `pyproject.toml`
- Centralizar configs de ferramentas (black, ruff, mypy)
- **Esfor√ßo:** ~1-2 horas
- **Quando:** Junto com #1

#### 3. Dependency Management Moderno
- Migrar `requirements.txt` para `pyproject.toml` + pip-tools/poetry
- Adicionar `requirements-dev.txt` ou [dev] extras
- Lock de vers√µes para builds reproduz√≠veis
- **Esfor√ßo:** ~2-3 horas
- **Quando:** M√∫ltiplos desenvolvedores ou publica√ß√£o PyPI

**Nota para Claude Code:** N√£o implementar estas melhorias proativamente. Focar em funcionalidades dos √âpicos 3-5 primeiro.

---

## üìö Refer√™ncias √öteis

### LangGraph
- Docs oficiais: https://langchain-ai.github.io/langgraph/
- Handling de interrupts: https://langchain-ai.github.io/langgraph/concepts/human_in_the_loop/
- Checkpointers: https://langchain-ai.github.io/langgraph/concepts/persistence/

### Pytest
- Markers: https://docs.pytest.org/en/stable/how-to/mark.html
- Fixtures: https://docs.pytest.org/en/stable/how-to/fixtures.html

### Anthropic API
- Console: https://console.anthropic.com/
- Pricing: https://www.anthropic.com/pricing

---

**√öltima atualiza√ß√£o:** 11/11/2025
**Mantido por:** Claude Code (sess√µes de desenvolvimento)
